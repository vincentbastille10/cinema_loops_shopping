<!doctype html>
<html lang="{{ 'fr' if lang == 'fr' else 'en' }}">
<head>
  <meta charset="utf-8" />

  <title>Spectra Film Loops – Horror & Cinema Audio Loops</title>

  <meta name="description"
        content="Boucles audio cinématiques pour films, horreur, danse et installations. WAV haute qualité, pré-écoute MP3, paiement Stripe, 1€ par loop." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://cinema-loops-shopping.onrender.com/" />

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://js.stripe.com/v3/"></script>
  <script src="{{ url_for('static', filename='lang.js') }}"></script>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1>Spectra Film Loops</h1>
        <p class="subtitle" data-i18n="header_sub">
          Boucles audio professionnelles pour films, danse, horreur et installations. WAV haute qualité.
        </p>
      </div>

      <div class="header-right">
        <!-- Sélecteur de langue -->
        <div class="lang-switch">
          <button type="button" class="lang-btn" data-lang="fr">FR</button>
          <button type="button" class="lang-btn" data-lang="en">EN</button>
        </div>

        <!-- Bouton voir panier -->
        <a href="{{ url_for('cart_page') }}" class="btn btn-cart" data-i18n="go_to_cart">
          Voir le panier
        </a>
      </div>
    </div>
  </header>

  <main class="main-container">
    {% if status == "success" %}
      <div class="status status-success" data-i18n="success_msg">
        Paiement réussi – vos liens de téléchargement vous ont été envoyés.
      </div>
    {% elif status == "cancel" %}
      <div class="status status-cancel" data-i18n="cancel_msg">
        Paiement annulé – aucune boucle n'a été débitée.
      </div>
    {% endif %}

    <form id="loops-form" onsubmit="return false;">
      {% for cat in categories %}
        {# id avec tirets pour les ancres SEO #}
        <section id="{{ cat.id.replace('_', '-') }}">
          <h2>{{ cat.title }}</h2>
          {% if cat.description %}
            <p class="section-subtitle">{{ cat.description }}</p>
          {% endif %}

          <div class="loop-list">
            {% for audio in cat.loops %}
              <div class="loop-card">
                <div class="loop-header">
                  <div class="loop-left">
                    <input
                      type="checkbox"
                      class="loop-checkbox"
                      name="loop"
                      value="{{ audio.id }}"
                      id="chk_{{ audio.id }}"
                    >
                    {# Nom fidèle au fichier = audio.file #}
                    <label class="loop-name" for="chk_{{ audio.id }}">
                      {{ audio.file }}
                    </label>
                  </div>
                  <span class="loop-price">{{ audio.price_eur|round(2) }}€</span>
                </div>

                <audio class="loop-player" controls preload="none">
                  <source src="{{ audio.preview }}" type="audio/mpeg">
                  Votre navigateur ne supporte pas l'audio HTML5.
                </audio>

                <div class="loop-actions">
                  <button
                    type="button"
                    class="btn btn-small btn-add"
                    data-loop-id="{{ audio.id }}"
                    data-i18n="add_to_cart"
                  >
                    Ajouter au panier
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </section>
      {% endfor %}
    </form>

    <div class="go-cart-bottom">
      <a href="{{ url_for('cart_page') }}" class="btn btn-cart" data-i18n="go_to_cart">
        Voir le panier
      </a>
    </div>
  </main>

 <footer>
  <a href="{{ url_for('about_page', lang=lang) }}" class="footer-link">
    About / Licence
  </a>
  • Spectra Media – Film & Horror Audio Loops
</footer>


  <script>
    // --- Gestion de la langue (FR/EN) ---
    const S_LANG = window.SPECTRA_LANG || {};
    const DEFAULT_LANG = "{{ 'fr' if lang == 'fr' else 'en' }}";

    function applyLanguage(lang) {
      const dict = S_LANG[lang] || S_LANG["fr"];
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) {
          el.textContent = dict[key];
        }
      });
      // stocker la langue
      try {
        localStorage.setItem("spectra_lang", lang);
      } catch (e) {}
    }

    function initLanguage() {
      let saved = null;
      try {
        saved = localStorage.getItem("spectra_lang");
      } catch (e) {}
      const lang = saved || DEFAULT_LANG;

      applyLanguage(lang);

      document.querySelectorAll(".lang-btn").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-lang") === lang);
        btn.addEventListener("click", () => {
          const newLang = btn.getAttribute("data-lang");
          applyLanguage(newLang);
          document.querySelectorAll(".lang-btn").forEach(b =>
            b.classList.toggle("active", b.getAttribute("data-lang") === newLang)
          );
        });
      });
    }

    // --- Gestion audio : une seule loop en lecture à la fois ---
    function initAudioPlayers() {
      const players = Array.from(document.querySelectorAll("audio.loop-player"));
      players.forEach(player => {
        player.addEventListener("play", () => {
          players.forEach(other => {
            if (other !== player) {
              other.pause();
              other.currentTime = 0;
            }
          });
        });
      });
    }

    // --- Panier : stocké dans localStorage ---
    function getCartIds() {
      try {
        const raw = localStorage.getItem("spectra_cart");
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        return [];
      }
    }

    function saveCartIds(ids) {
      try {
        localStorage.setItem("spectra_cart", JSON.stringify(ids));
      } catch (e) {}
    }

    function addToCart(id) {
      const ids = getCartIds();
      if (!ids.includes(id)) {
        ids.push(id);
        saveCartIds(ids);
      }
    }

    function initAddToCartButtons() {
      document.querySelectorAll(".btn-add").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-loop-id");
          addToCart(id);
          btn.classList.add("btn-added");
          setTimeout(() => btn.classList.remove("btn-added"), 600);
        });
      });

      // Si l'utilisateur coche/décoche, on synchronise aussi
      document.querySelectorAll(".loop-checkbox").forEach(chk => {
        chk.addEventListener("change", () => {
          const id = chk.value;
          if (chk.checked) {
            addToCart(id);
          } else {
            const ids = getCartIds().filter(x => x !== id);
            saveCartIds(ids);
          }
        });
      });

      // Initialiser les checkbox en fonction du localStorage
      const current = getCartIds();
      document.querySelectorAll(".loop-checkbox").forEach(chk => {
        chk.checked = current.includes(chk.value);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initLanguage();
      initAudioPlayers();
      initAddToCartButtons();
    });
  </script>
</body>
</html>
